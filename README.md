# 回测系统介绍

## 1. 系统架构

回测系统由3部分组成: 数据引擎, 策略类, 回测引擎, 分别封装在3个.py文件中, 共同组成`backtest`模块. 它们分别的功能是:

1. 提供一个数据集类和一些基础接口, 用于加载和调用数据;
2. 提供一个策略基类, 用户可以在此基类上自行设计策略类;
3. 提供一个回测类, 建立一个回测实例并读入一个策略实例后即可进行回测.

回测系统满足基础需求: 在给定的数据下, 实现一个能够在【任何时间区间】回测【n】日反转策略的系统. 回测结果展示该策略的：净值曲线, 超额收益, 年化收益, 年化波动, 夏普比率, 最大回撤.

对数据集类, 我们额外提供了便于研究的基础数据接口, 和用于策略设计的时间序列和截面数据接口.

对策略类, 我们固定了信号函数, 函数可以调用数据集类的时间序列和截面数据接口, 因此用户可以同时设计各类时间序列和截面的策略, 也可以耦合多种信号得到一个综合信号作为策略.

对回测类, 除提供回测区间以外, 我们还提供交易频率, 滑点, 选股比例, 做空, 权重函数等自由度, 基本通过pandas接口快速实现.

由于财务因子种类多, 缺失值多, 行业跨度大, 所以本次回测系统设计未进行考虑, 但实际上这一从数据集类到策略类再到回测引擎的工作流可以进行有效拓展, 包括:

1. 单因子评价, 包括因子IC, 分布等功能;
2. 多因子选股, 包括因子中性化, 行业中性化, 市值中性化, 风格中性化等功能;
3. 策略类的进一步丰富, 包括提供常见的信号处理接口等;
4. 回测方法的进一步丰富, 比如更多的图形化结果, 或因子的单独和相关的研究.

下面对各部分的具体功能和代码实现进行介绍. **注意, 对于个别函数, 函数字段等严格解释请查看原始文件. 所有代码都已经过详细注释说明, 本身即可构成一份文档.**

## 2. 数据引擎

数据引擎通过`DataLoader`类进行实现. 实例化该类, 需要传入数据路径信息, 然后该实例将自动读取和处理数据 (如计算复权价格和收益率) 并提供基础数据接口.

数据引擎的各个接口, 包括调用个股, 调用日期截面, 调用特殊字段等都将对策略研究起到支持作用.

数据引擎和策略类的耦合在于, 提供了组织好的时间序列和截面数据接口, 用于策略类的信号函数直接调用. 这一部分及此后全部系统对数据的时序和截面的处理方式几乎都是通过DataFrame.groupby的方式实现的, 以保证代码的通用性与高效性.

数据引擎和回测引擎的耦合在于, 提前在内部计算了回测需要使用的回报率, 并提供了生成信号, 截取数据进行回测的原始数据接口.

## 3. 策略类

策略类通过`Strategy`基类进行实现. 创建策略, 需要构造一个策略类, 继承基类`Strategy`, 并定义固定名函数`signal`. 其结构其实类似于PyTorch的模型结构.

在`signal`函数内, 用户接收一个数据引擎`DataLoader`作为输入, 并需要设计信号生成方式, 其间可以调用数据引擎提供的各种接口, 以完成时序和截面处理的不同需求. 处理方式基本是面向DataFrame的, 所以pandas的各种方法都可以被使用.

策略类不直接接收数据引擎, 而是独立存在. 在回测时用户需要将一个策略实例放入回测引擎中, 同时将数据引擎放入回测引擎中进行回测.

## 4. 回测引擎

回测引擎通过`Backtest`类进行实现. 创建回测, 需要实例化一个回测类, 并传入一个策略实例和一个数据引擎实例. 回测类提供了一系列接口, 用于设置回测参数, 进行回测, 以及展示回测结果.

回测引擎的运行方式是, 调用`run`函数, 按顺序进行: 调用回测函数并获取回测收益率结果, 调用评估函数并获取评估结果. 回测结束后即可调用`plot`函数展示回测结果. 其中回测函数评估函数将返回包含回测结果的各项指标的一个DataFrame. **引擎在以上运行过程中默认额外生成全市场等权选股的策略作为benchmark.**

回测引擎提供的自由度有:

1. 回测区间;
2. 交易频率, 这一部分通过DataFrame.groupby和Grouper实现 (理论上也可以通过resample实现, 但groupby方法更为通用, 设计过程未进行对比测试), 接受pandas.Grouper支持的所有字符串或一个自定义Grouper对象;
3. 滑点, 即交易成本, 这是由于添加了交易频率自由度才得以添加的可调参数;
4. 初始仓位;
5. 做空, 如果开启则默认以等仓位做多和做空股票, 仓位之和为2倍初始仓位;
6. 做多比例, 即选股中的一个自由度, 默认做多信号排名前10%的股票;
7. 做空比例, 同上;
8. 权重函数, 即选股后的权重分配方式, 默认等权重分配.

回测系统的使用样例详见notebook.
